# ä½¿ç”¨Python 3.9ä½œä¸ºåŸºç¡€é•œåƒ
FROM python:3.9-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgtk-3-0 \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶requirementsæ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8080 8765

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV PYTHONPATH=/app/src/backend
ENV DISPLAY=:0

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ðŸ³ å¯åŠ¨æ³¡æ³¡æ¸¸æˆDockerå®¹å™¨"\n\
echo "================================"\n\
\n\
# å¯åŠ¨WebSocketæœåŠ¡å™¨ï¼ˆåŽå°ï¼‰\n\
cd /app/src/backend\n\
python pose_websocket_server.py --host 0.0.0.0 &\n\
\n\
# ç­‰å¾…WebSocketæœåŠ¡å™¨å¯åŠ¨\n\
sleep 3\n\
\n\
# å¯åŠ¨HTTPæœåŠ¡å™¨ï¼ˆå‰å°ï¼‰\n\
cd /app\n\
python -m http.server 8080 --bind 0.0.0.0\n\
' > /app/start.sh && chmod +x /app/start.sh

# é»˜è®¤å‘½ä»¤
CMD ["/app/start.sh"]