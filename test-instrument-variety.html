<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³è‰²å¤šæ ·æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .instrument-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .instrument-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            text-align: center;
        }
        .instrument-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .instrument-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            margin: 2px;
            border: none;
            border-radius: 5px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background: #1976D2;
        }
        button.playing {
            background: #4CAF50;
        }
        .style-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .style-btn {
            padding: 10px 20px;
            font-size: 14px;
        }
        .style-btn.active {
            background: #FF5722;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .music-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h1>ğŸµ éŸ³è‰²å¤šæ ·æ€§æµ‹è¯•</h1>
        <p>æµ‹è¯•ä¸åŒæ¸¸æˆè¡¨ç°ä¸‹çš„éŸ³ä¹é£æ ¼å’Œä¹å™¨ç»„åˆå˜åŒ–</p>
        
        <div class="style-selector">
            <button class="style-btn active" onclick="testMusicStyle('peaceful', 3)">ğŸ•Šï¸ å¹³é™é£æ ¼ (3ä¸ªæ³¡æ³¡)</button>
            <button class="style-btn" onclick="testMusicStyle('gentle', 8)">ğŸŒ¸ æ¸©å’Œé£æ ¼ (8ä¸ªæ³¡æ³¡)</button>
            <button class="style-btn" onclick="testMusicStyle('cheerful', 15)">ğŸ˜Š æ¬¢å¿«é£æ ¼ (15ä¸ªæ³¡æ³¡)</button>
            <button class="style-btn" onclick="testMusicStyle('upbeat', 25)">ğŸ‰ æ´»è·ƒé£æ ¼ (25ä¸ªæ³¡æ³¡)</button>
            <button class="style-btn" onclick="testMusicStyle('energetic', 40)">âš¡ é«˜èƒ½é£æ ¼ (40ä¸ªæ³¡æ³¡)</button>
        </div>
        
        <div class="music-info" id="music-info">
            <h3>å½“å‰éŸ³ä¹ä¿¡æ¯</h3>
            <div id="current-style">é£æ ¼: æœªé€‰æ‹©</div>
            <div id="current-instruments">ä¹å™¨: æœªç”Ÿæˆ</div>
            <div id="current-tempo">èŠ‚æ‹: æœªè®¾ç½®</div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="playCurrentMusic()" style="font-size: 16px; padding: 12px 24px;">ğŸµ æ’­æ”¾å½“å‰éŸ³ä¹</button>
            <button onclick="stopMusic()" style="font-size: 16px; padding: 12px 24px; background: #f44336;">â¹ï¸ åœæ­¢æ’­æ”¾</button>
            <button onclick="downloadMusic()" style="font-size: 16px; padding: 12px 24px; background: #FF9800;">ğŸ’¾ ä¸‹è½½MIDI</button>
        </div>
        
        <div class="instrument-grid" id="instrument-grid">
            <!-- ä¹å™¨å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="src/frontend/js/advanced-music-generator.js"></script>
    
    <script>
        let currentMusic = null;
        let currentPlayer = null;
        let generator = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            generator = new AdvancedMusicGenerator();
            log('ğŸµ é«˜çº§éŸ³ä¹ç”Ÿæˆå™¨å·²åˆå§‹åŒ–');
            log('ğŸ’¡ ç‚¹å‡»ä¸åŒé£æ ¼æŒ‰é’®æ¥æµ‹è¯•éŸ³è‰²å˜åŒ–');
            
            // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
            initAudioPlayer();
        });
        
        function initAudioPlayer() {
            // åˆ›å»ºç®€å•çš„Web Audioæ’­æ”¾å™¨
            try {
                window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                log('ğŸ”Š éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆ›å»º');
            } catch (e) {
                log('âŒ éŸ³é¢‘ä¸Šä¸‹æ–‡åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }
        
        function testMusicStyle(styleName, bubbleCount) {
            log(`ğŸ¯ æµ‹è¯• ${styleName} é£æ ¼ï¼Œæ¨¡æ‹Ÿ ${bubbleCount} ä¸ªæ³¡æ³¡`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ›å»ºæ¨¡æ‹Ÿæ¸¸æˆä¼šè¯
            const mockSession = createMockSession(bubbleCount);
            
            // ç”ŸæˆéŸ³ä¹
            currentMusic = generator.generateMusic(mockSession);
            
            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            updateMusicInfo(currentMusic);
            
            // æ›´æ–°ä¹å™¨ç½‘æ ¼
            updateInstrumentGrid(currentMusic);
            
            log(`âœ… ${styleName} é£æ ¼éŸ³ä¹å·²ç”Ÿæˆ`);
            log(`   ä¹å™¨æ•°é‡: ${currentMusic.instrumentInfos.length}`);
            log(`   éŸ³ç¬¦æ•°é‡: ${currentMusic.notes.length}`);
            log(`   æ€»æ—¶é•¿: ${currentMusic.totalTime.toFixed(1)}ç§’`);
        }
        
        function createMockSession(bubbleCount) {
            const notes = [];
            const duration = 60; // 60ç§’æ¸¸æˆ
            
            // ç”Ÿæˆæ¨¡æ‹ŸéŸ³ç¬¦æ•°æ®
            for (let i = 0; i < bubbleCount; i++) {
                notes.push({
                    dt: (i / bubbleCount) * duration * 1000,
                    midi: 60 + Math.floor(Math.random() * 24),
                    freq: 261.63 * Math.pow(2, Math.floor(Math.random() * 24) / 12)
                });
            }
            
            return {
                notes: notes,
                durationSec: duration,
                startedAt: Date.now() - duration * 1000,
                endedAt: Date.now()
            };
        }
        
        function updateMusicInfo(music) {
            if (!music || !music.metadata) return;
            
            document.getElementById('current-style').textContent = 
                `é£æ ¼: ${music.metadata.style} (${music.metadata.scale}è°ƒå¼)`;
            
            const instrumentNames = music.instrumentInfos.map(inst => inst.name).join(', ');
            document.getElementById('current-instruments').textContent = 
                `ä¹å™¨: ${instrumentNames}`;
            
            const tempo = music.tempos && music.tempos[0] ? music.tempos[0].qpm : 'æœªçŸ¥';
            document.getElementById('current-tempo').textContent = 
                `èŠ‚æ‹: ${tempo} BPM`;
        }
        
        function updateInstrumentGrid(music) {
            const grid = document.getElementById('instrument-grid');
            grid.innerHTML = '';
            
            if (!music || !music.instrumentInfos) return;
            
            music.instrumentInfos.forEach((instrument, index) => {
                const card = document.createElement('div');
                card.className = 'instrument-card';
                
                // è®¡ç®—è¯¥ä¹å™¨çš„éŸ³ç¬¦æ•°é‡
                const instrumentNotes = music.notes.filter(note => 
                    note.instrument === instrument.instrument
                );
                
                card.innerHTML = `
                    <div class="instrument-name">${instrument.name}</div>
                    <div class="instrument-info">
                        ç¨‹åº: ${instrument.program}<br>
                        é€šé“: ${instrument.instrument}<br>
                        éŸ³ç¬¦: ${instrumentNotes.length}ä¸ª
                    </div>
                    <button onclick="playInstrumentSample(${instrument.program}, ${instrument.instrument})">
                        ğŸµ è¯•å¬
                    </button>
                    <button onclick="showInstrumentNotes(${instrument.instrument})">
                        ğŸ“ æŸ¥çœ‹éŸ³ç¬¦
                    </button>
                `;
                
                grid.appendChild(card);
            });
        }
        
        function playInstrumentSample(program, channel) {
            log(`ğŸµ è¯•å¬ä¹å™¨ - ç¨‹åº: ${program}, é€šé“: ${channel}`);
            
            if (!currentMusic) {
                log('âŒ æ²¡æœ‰å½“å‰éŸ³ä¹å¯ä»¥è¯•å¬');
                return;
            }
            
            // æ’­æ”¾è¯¥ä¹å™¨çš„å‰å‡ ä¸ªéŸ³ç¬¦
            const instrumentNotes = currentMusic.notes
                .filter(note => note.instrument === channel)
                .slice(0, 5); // åªæ’­æ”¾å‰5ä¸ªéŸ³ç¬¦
            
            if (instrumentNotes.length === 0) {
                log('âŒ è¯¥ä¹å™¨æ²¡æœ‰éŸ³ç¬¦');
                return;
            }
            
            log(`ğŸµ æ’­æ”¾ ${instrumentNotes.length} ä¸ªéŸ³ç¬¦æ ·æœ¬`);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éŸ³é¢‘æ’­æ”¾é€»è¾‘
            // ç”±äºæ²¡æœ‰å®Œæ•´çš„MIDIæ’­æ”¾å™¨ï¼Œæˆ‘ä»¬åªæ˜¯æ˜¾ç¤ºä¿¡æ¯
            instrumentNotes.forEach((note, index) => {
                setTimeout(() => {
                    log(`â™ª éŸ³ç¬¦ ${index + 1}: éŸ³é«˜=${note.pitch}, åŠ›åº¦=${note.velocity}`);
                }, index * 200);
            });
        }
        
        function showInstrumentNotes(channel) {
            if (!currentMusic) return;
            
            const instrumentNotes = currentMusic.notes.filter(note => 
                note.instrument === channel
            );
            
            log(`ğŸ“ é€šé“ ${channel} çš„éŸ³ç¬¦è¯¦æƒ…:`);
            instrumentNotes.slice(0, 10).forEach((note, index) => {
                log(`   ${index + 1}. éŸ³é«˜:${note.pitch} æ—¶é—´:${note.startTime.toFixed(2)}s åŠ›åº¦:${note.velocity}`);
            });
            
            if (instrumentNotes.length > 10) {
                log(`   ... è¿˜æœ‰ ${instrumentNotes.length - 10} ä¸ªéŸ³ç¬¦`);
            }
        }
        
        function playCurrentMusic() {
            if (!currentMusic) {
                log('âŒ æ²¡æœ‰éŸ³ä¹å¯ä»¥æ’­æ”¾ï¼Œè¯·å…ˆé€‰æ‹©ä¸€ä¸ªé£æ ¼');
                return;
            }
            
            log('ğŸµ å¼€å§‹æ’­æ”¾éŸ³ä¹...');
            log('ğŸ’¡ ç”±äºè¿™æ˜¯æµ‹è¯•é¡µé¢ï¼Œå®é™…æ’­æ”¾éœ€è¦å®Œæ•´çš„MIDIæ’­æ”¾å™¨');
            log(`ğŸµ éŸ³ä¹ä¿¡æ¯: ${currentMusic.notes.length}ä¸ªéŸ³ç¬¦, ${currentMusic.instrumentInfos.length}ç§ä¹å™¨`);
            
            // æ˜¾ç¤ºéŸ³ä¹çš„è¯¦ç»†ä¿¡æ¯
            currentMusic.instrumentInfos.forEach(inst => {
                const noteCount = currentMusic.notes.filter(n => n.instrument === inst.instrument).length;
                log(`   ${inst.name}: ${noteCount}ä¸ªéŸ³ç¬¦`);
            });
        }
        
        function stopMusic() {
            log('â¹ï¸ åœæ­¢æ’­æ”¾');
        }
        
        function downloadMusic() {
            if (!currentMusic) {
                log('âŒ æ²¡æœ‰éŸ³ä¹å¯ä»¥ä¸‹è½½');
                return;
            }
            
            try {
                // åˆ›å»ºJSONæ ¼å¼çš„éŸ³ä¹æ•°æ®
                const musicData = {
                    ...currentMusic,
                    downloadInfo: {
                        generatedAt: new Date().toISOString(),
                        style: currentMusic.metadata?.style || 'unknown',
                        noteCount: currentMusic.notes.length,
                        instrumentCount: currentMusic.instrumentInfos.length
                    }
                };
                
                const jsonData = JSON.stringify(musicData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `music_${currentMusic.metadata?.style || 'test'}_${Date.now()}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                log('ğŸ’¾ éŸ³ä¹æ•°æ®å·²ä¸‹è½½ä¸ºJSONæ ¼å¼');
            } catch (error) {
                log('âŒ ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
    </script>
</body>
</html>