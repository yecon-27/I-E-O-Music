<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Popping Game</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
      .lane-labels {
        position: absolute;
        left: 0;
        bottom: 8px;
        width: 100%;
        pointer-events: none;
        z-index: 5;
      }
      .lane-labels .lane-label {
        position: absolute;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        color: #ffffff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      }
      .click-trail {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        pointer-events: none;
        font-size: 12px;
        font-weight: 700;
        background: rgba(0,0,0,0.12);
        border-radius: 14px;
        z-index: 6;
      }
      .click-trail .trail-dot {
        min-width: 18px;
        min-height: 18px;
        padding: 2px 6px;
        border-radius: 10px;
        color: #fff;
        text-align: center;
        line-height: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.25);
      }
      .click-trail .trail-title {
        color: #fff;
        opacity: 0.8;
      }
      .game-main { position: relative; }
    </style>
</head>
<body>


    <div class="game-container">
        <div class="game-header">
            <!-- Left: Settings & Language -->
            <div class="header-section header-left">
                <button id="session-settings-btn" class="control-btn secondary-btn">âš™ï¸ å‚æ•°</button>
                <button id="lang-toggle-btn" class="control-btn secondary-btn">ğŸŒ ä¸­/EN</button>
            </div>

            <!-- Center: Progress -->
            <div class="header-section header-center">
                <div class="progress-indicator">
                    <div class="time-remaining">
                        <span id="countdown-display">60s</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="header-section header-right">
                <div class="play-controls">
                    <button id="pause-btn" class="control-btn primary-btn">â¸ï¸ æš‚åœ</button>
                    <button id="panic-mute-btn" class="control-btn panic-btn">ğŸ”‡ é™éŸ³</button>
                </div>
                <div class="speed-controls">
                    <button id="slow-btn" class="speed-btn">ğŸŒ</button>
                    <button id="normal-btn" class="speed-btn active">ğŸš¶</button>
                    <button id="fast-btn" class="speed-btn">ğŸƒ</button>
                </div>
            </div>
            
            <!-- Hidden/Legacy containers to keep JS happy if needed, though most use IDs -->
            <div class="controls" style="display:none;"></div>
            <div id="session-preset" class="session-preset" style="display:none;"></div>
        </div>
        
        <div class="game-area">
            <div class="game-main">
                <canvas id="game-canvas" width="1024" height="768"></canvas>
                <div id="click-trail" class="click-trail"></div>
                <div id="lane-labels" class="lane-labels"></div>
                <div id="encouragement-message" class="encouragement-message"></div>
                <div id="pause-overlay" class="pause-overlay hidden">
                    <h2>æ¸¸æˆå·²æš‚åœ</h2>
                    <p>ç‚¹å‡»ç»§ç»­æŒ‰é’®æ¢å¤æ¸¸æˆ</p>
                </div>
                
                <!-- æ¸¸æˆç»“æœçª—å£ -->
                <div id="game-result-overlay" class="game-result-overlay hidden">
                    <div class="result-content" style="position: relative;">
                        <button id="post-session-btn" class="result-btn small secondary" style="position: absolute; top: 20px; right: 20px; z-index: 2005;">
                            Post Session View
                        </button>
                        <h2>ğŸ‰ æ¸¸æˆç»“æŸï¼</h2>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-icon">ğŸ¯</span>
                                <span class="stat-label">æˆåŠŸå‡»ç ´</span>
                                <span id="result-bubbles" class="stat-value">0</span>
                                <span class="stat-unit">ä¸ªæ³¡æ³¡</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">âš¡</span>
                                <span class="stat-label">å¹³å‡é€Ÿåº¦</span>
                                <span id="result-speed" class="stat-value">0</span>
                                <span class="stat-unit">ç§’/ä¸ª</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">ğŸ†</span>
                                <span class="stat-label">æœ€é«˜è¿å‡»</span>
                                <span id="result-combo" class="stat-value">0</span>
                                <span class="stat-unit">è¿ç»­</span>
                            </div>
                        </div>
                        <div class="result-message">
                            <p id="result-encouragement">å¤ªæ£’äº†ï¼ä½ çš„è¡¨ç°å¾ˆå‡ºè‰²ï¼</p>
                        </div>
                        <div id="debug-panel" class="debug-panel hidden">
                            <div class="debug-header">
                                <h3>Post-Session Review</h3>
                                <div class="debug-header-actions">
                                    <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 4px; color: var(--text-secondary);">
                                        <input type="checkbox" id="expert-mode-checkbox"> ä¸“å®¶æ¨¡å¼
                                    </label>
                                    <button id="debug-help-toggle" class="result-btn secondary small">How to read</button>
                                    <button id="open-reward-controls-btn" class="result-btn secondary small">Open Reward Controls</button>
                                </div>
                            </div>
                            <div id="debug-help" class="debug-help hidden">
                                <strong>How to read this panel</strong>
                                <ol>
                                    <li>Q1ï¼šåˆ¤å®šç»“æœ + å®‰å…¨çŠ¶æ€</li>
                                    <li>Q2ï¼šè¯æ®å¯è§†åŒ– + Top-3 è§„åˆ™</li>
                                    <li>Q3ï¼šåäº‹å®è§£é‡Š + å®¡è®¡</li>
                                </ol>
                            </div>
                            <div class="debug-section">
                                <h4 class="debug-section-title">Q1ï¼šç³»ç»Ÿåˆ¤å®šäº†ä»€ä¹ˆï¼Ÿæ˜¯å¦å®‰å…¨ï¼Ÿ</h4>
                                <div class="debug-overview">
                                    <div class="overview-item">
                                        <span class="overview-label">åˆ¤å®šç»“æœï¼ˆä¸»/æ¬¡ï¼‰</span>
                                        <span id="debug-summary-decision" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">ç½®ä¿¡åº¦</span>
                                        <span id="debug-summary-confidence" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">å®‰å…¨çŠ¶æ€</span>
                                        <span id="debug-summary-safety" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">Reward æ¦‚è§ˆ</span>
                                        <span id="debug-summary-reward" class="overview-value">-</span>
                                    </div>
                                </div>
                                <div id="debug-summary-reason" class="debug-reason">-</div>
                                <div class="debug-grid">
                                    <div class="debug-block">
                                        <h4>ç”Ÿæˆç»“æ„æ‘˜è¦</h4>
                                        <ul id="debug-structure-list" class="debug-list"></ul>
                                    </div>
                                </div>
                            </div>

                            <div class="debug-section">
                                <h4 class="debug-section-title">Q2ï¼šä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ¤ï¼Ÿè¯æ®é•¿ä»€ä¹ˆæ ·ï¼Ÿ</h4>
                                <div class="debug-grid">
                                    <div class="debug-block debug-block-wide">
                                        <h4>ç‚¹å‡»è½¨è¿¹ä¸ Lane åˆ†å¸ƒ</h4>
                                        <canvas id="debug-timeline" class="debug-timeline" width="640" height="90"></canvas>
                                        <div id="debug-lane-bars" class="debug-lane-bars"></div>
                                    </div>
                                    <div class="debug-block">
                                        <h4>æ£€æµ‹åˆ°çš„ Patternï¼ˆæ•°å­—è¯æ®ï¼‰</h4>
                                        <ul id="debug-what-list" class="debug-list"></ul>
                                    </div>
                                    <div class="debug-block">
                                        <h4>Top-3 è§„åˆ™è¯æ®</h4>
                                        <ul id="debug-why-list" class="debug-list"></ul>
                                        <details class="debug-details">
                                            <summary>æŸ¥çœ‹æ›´å¤šè§„åˆ™</summary>
                                            <ul id="debug-why-details-list" class="debug-list"></ul>
                                        </details>
                                    </div>
                                    <div class="debug-block">
                                        <h4>ä¸‰ç±»è¯æ®å¾—åˆ†ï¼ˆç”¨äºå†³ç­–ï¼‰</h4>
                                        <ul id="debug-signal-list" class="debug-list"></ul>
                                        <div class="debug-note">æœ€ç»ˆæ ‡ç­¾=å¾—åˆ†æœ€é«˜è€…ï¼›å·®è·è¶Šå¤§â†’ç½®ä¿¡åº¦è¶Šé«˜ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div class="debug-section">
                                <h4 class="debug-section-title">Q3ï¼šå¦‚æœä¸“å®¶ä¸åŒæ„ï¼Œæ€ä¹ˆè°ƒï¼Ÿ</h4>
                                <div class="debug-grid">
                                    <div class="debug-block">
                                        <h4>What would change the decision?</h4>
                                        <ul id="debug-counterfactual-list" class="debug-list"></ul>
                                    </div>
                                    <div class="debug-block">
                                        <h4>çº¦æŸå®¡è®¡ï¼ˆAuditï¼‰</h4>
                                        <ul id="debug-constraint-list" class="debug-list"></ul>
                                        <div class="debug-note">Safety by design: reward ç”Ÿæˆå™¨=çº¦æŸé›†åˆï¼Œè€Œä¸æ˜¯äº‹åè¿‡æ»¤ã€‚</div>
                                    </div>
                                    <div class="debug-block">
                                        <h4>æœ¬è½®é…ç½® / å˜æ›´è®°å½•</h4>
                                        <ul id="debug-config-list" class="debug-list"></ul>
                                        <div class="debug-note">å±•ç¤ºä¸ä¿å®ˆé»˜è®¤å€¼çš„å·®å¼‚ï¼Œä¾¿äºå®¡è®¡ä¸å¤ç°ã€‚</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button id="play-music-btn" class="result-btn music">ğŸµ äº«å—ä½ åˆ›ä½œçš„éŸ³ä¹</button>
                            <button id="result-mute-btn" class="result-btn secondary panic-btn">ğŸ”‡ åœæ­¢/é™éŸ³</button>
                            <button id="play-again-btn" class="result-btn primary">ğŸ® å†ç©ä¸€è½®</button>
                            <button id="finish-game-btn" class="result-btn secondary">âœ¨ ç»“æŸæ¸¸æˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="game-footer">
            <div class="instructions">
                <p>ğŸ¯ ç§»åŠ¨å…‰æ ‡æˆ³æ³¡æ³¡ï¼</p>
                <div class="status-display" style="display: flex; gap: 20px; justify-content: center; margin: 10px 0;">
                    <div class="status-item">
                        <span>è¾“å…¥æ–¹å¼: </span>
                        <span id="input-mode" style="font-weight: bold; color: #2196F3;">é¼ æ ‡</span>
                    </div>
                    <div class="status-item">
                        <span>æ³¡æ³¡æ•°: </span>
                        <span id="bubble-count" style="font-weight: bold; color: #4CAF50;">0</span>
                    </div>
                </div>
                <div id="debug-info" class="debug-info" style="font-size: 0.9rem; color: #6C757D; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Session Settings Modal -->
    <div id="session-settings-modal" class="settings-modal hidden">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>æ¸¸æˆè®¾ç½®</h2>
                <p class="settings-subtitle">è°ƒæ•´æ„Ÿå®˜ä½“éªŒï¼Œè®©æ¸¸æˆæ›´é€‚åˆä½ </p>
            </div>
            
            <div class="settings-scroll-area">
                <div class="settings-grid">
                    <div class="settings-field">
                        <label for="session-volume">éŸ³é‡å¤§å°</label>
                        <select id="session-volume">
                            <option value="low">æŸ”å’Œ (Low)</option>
                            <option value="medium" selected>æ ‡å‡† (Medium)</option>
                            <option value="high">å“äº® (High)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="session-density">æ³¡æ³¡æ•°é‡</label>
                        <select id="session-density">
                            <option value="sparse">å°‘ä¸€ç‚¹ (Sparse)</option>
                            <option value="normal" selected>æ­£å¸¸ (Normal)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="session-timbre">ä¹å™¨éŸ³è‰²</label>
                        <select id="session-timbre">
                            <option value="soft" selected>æŸ”å’Œé’¢ç´ (Soft)</option>
                            <option value="bright">æ˜äº®å°æç´ (Bright)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="session-latency">å£°éŸ³å»¶è¿Ÿ</label>
                        <select id="session-latency">
                            <option value="0" selected>å³æ—¶ (Immediate)</option>
                            <option value="500">ç¨æ…¢ (0.5s Delay)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="session-immediate">ç‚¹å‡»åé¦ˆ</label>
                        <select id="session-immediate">
                            <option value="full" selected>å£°éŸ³+è§†è§‰ (Full)</option>
                            <option value="visual">ä»…è§†è§‰ (Visual-only)</option>
                            <option value="off">å…³é—­ (Off)</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label for="session-reward">ç»“æŸéŸ³ä¹</label>
                        <select id="session-reward">
                            <option value="on" selected>å¼€å¯ (On)</option>
                            <option value="off">å…³é—­ (Off)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button id="session-reset-btn" class="result-btn secondary small">æ¢å¤é»˜è®¤</button>
                <button id="session-start-btn" class="result-btn primary small">å¼€å§‹æ¸¸æˆ</button>
                <button id="session-close-btn" class="result-btn secondary small">å…³é—­</button>
            </div>
        </div>
    </div>

    <script src="js/audio-notes.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/note-log.js"></script>
    <script src="js/advanced-music-generator.js"></script>
    <script src="js/autism-friendly-features.js"></script>
    <script src="js/game-result-manager.js"></script>
    <script src="js/game-integration.js"></script>
    <script src="js/debug-collision.js"></script>

    <script src="js/bubble-manager.js"></script>
    <script src="js/collision-detector.js"></script>
    <script src="js/game-engine.js"></script>

  
    <!-- TFJS & Magentaï¼ˆåœ¨ä»“åº“æ ¹çš„ vendor ä¸‹ï¼‰ -->
    <script src="../../vendor/tf/tf.min.js"></script>
    <script src="../../vendor/magenta/music.js"></script>

    <!-- å…¥å£ä¿æŒ module -->
    <script type="module" src="./js/main.js"></script>
</body>
</html>
