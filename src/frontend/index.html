<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Popping Game</title>
    <!-- Preload Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/music-params.css">
    <style>
      .click-trail {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        pointer-events: none;
        font-size: 12px;
        font-weight: 700;
        /* click-trail Â∑≤Á¶ÅÁî®ÔºåÈöêËóèÂÆπÂô® */
        display: none;
      }
      .click-trail .trail-dot {
        min-width: 18px;
        min-height: 18px;
        padding: 2px 6px;
        border-radius: 10px;
        color: #fff;
        text-align: center;
        line-height: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.25);
      }
      .click-trail .trail-title {
        color: #fff;
        opacity: 0.8;
      }
      .game-main { position: relative; overflow: visible; }
    </style>
</head>
<body>


    <div class="game-container">
        <div class="game-header">
            <!-- Left: Mute (Panic) & Settings -->
            <div class="header-section header-left">
                <button id="panic-mute-btn" class="control-btn panic-btn hero-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                    <span style="margin-left:6px">ÈùôÈü≥</span>
                </button>
                <div class="divider-vertical"></div>
                <button id="session-settings-btn" class="control-btn secondary-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> 
                    <span style="margin-left:6px">ÂèÇÊï∞</span>
                </button>
                <button id="lang-toggle-btn" class="control-btn secondary-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg> 
                    <span style="margin-left:6px">‰∏≠/EN</span>
                </button>
            </div>

            <!-- Center: Progress -->
            <div class="header-section header-center">
                <div class="progress-indicator">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div class="time-remaining">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.6;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span id="countdown-display">60s</span>
                    </div>
                </div>
            </div>

            <!-- Right: Speed & Pause -->
            <div class="header-section header-right">
                <div class="speed-controls">
                    <button id="slow-btn" class="speed-btn" title="ÊÖ¢ÈÄü">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"></polygon><polygon points="22 19 13 12 22 5 22 19"></polygon></svg>
                        <span class="speed-label">ÊÖ¢ÈÄü</span>
                    </button>
                    <button id="normal-btn" class="speed-btn active" title="Ê≠£Â∏∏">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <span class="speed-label">Ê≠£Â∏∏</span>
                    </button>
                    <button id="fast-btn" class="speed-btn" title="Âø´ÈÄü">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
                        <span class="speed-label">Âø´ÈÄü</span>
                    </button>
                </div>
                <div class="divider-vertical"></div>
                <button id="pause-btn" class="control-btn primary-btn hero-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    <span style="margin-left:6px">ÊöÇÂÅú</span>
                </button>
                <!-- Hidden/Legacy containers to keep JS happy -->
                <div class="play-controls" style="display:none;"></div>
            </div>
            
            <div class="controls" style="display:none;"></div>
            <div id="session-preset" class="session-preset" style="display:none;"></div>
        </div>
        
        <div class="game-area">
            <div class="game-main">
                <canvas id="game-canvas" width="1024" height="768"></canvas>
                <div id="click-trail" class="click-trail"></div>
                <div id="lane-labels" class="lane-labels"></div>
                <div id="encouragement-message" class="encouragement-message"></div>
                <div id="pause-overlay" class="pause-overlay hidden">
                    <h2>Ê∏∏ÊàèÂ∑≤ÊöÇÂÅú</h2>
                    <p>ÁÇπÂáªÁªßÁª≠ÊåâÈíÆÊÅ¢Â§çÊ∏∏Êàè</p>
                </div>
                
                <!-- Ê∏∏ÊàèÁªìÊûúÁ™óÂè£ -->
                <div id="game-result-overlay" class="game-result-overlay hidden">
                    
                    <!-- ===== ÊôÆÈÄöÁî®Êà∑ËßÜÂõæ ===== -->
                    <div id="normal-result-view" class="result-content glass-panel">
                        <!-- ‰∏ìÂÆ∂Ê®°ÂºèÊåâÈíÆ - Âè≥‰∏äËßí -->
                        <button id="post-session-btn" class="expert-mode-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                            ‰∏ìÂÆ∂Ê®°Âºè
                        </button>
                        
                        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; display: flex; align-items: center; gap: 12px;">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                </svg>
                                Ê∏∏ÊàèÁªìÊùü
                            </h2>
                        </div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                                </span>
                                <span class="stat-label">ÊàêÂäüÂáªÁ†¥</span>
                                <span id="result-bubbles" class="stat-value">0</span>
                                <span class="stat-unit">‰∏™Ê≥°Ê≥°</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                </span>
                                <span class="stat-label">Âπ≥ÂùáÈÄüÂ∫¶</span>
                                <span id="result-speed" class="stat-value">0</span>
                                <span class="stat-unit">Áßí/‰∏™</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 1 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
                                </span>
                                <span class="stat-label">ÊúÄÈ´òËøûÂáª</span>
                                <span id="result-combo" class="stat-value">0</span>
                                <span class="stat-unit">ËøûÁª≠</span>
                            </div>
                        </div>
                        <div class="result-message">
                            <p id="result-encouragement">Â§™Ê£í‰∫ÜÔºÅ‰Ω†ÁöÑË°®Áé∞ÂæàÂá∫Ëâ≤ÔºÅ</p>
                        </div>
                        
                        <div class="result-actions">
                            <button id="play-music-btn" class="result-btn music">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18V5l12-2v13"></path>
                                    <circle cx="6" cy="18" r="3"></circle>
                                    <circle cx="18" cy="16" r="3"></circle>
                                </svg>
                                Êí≠Êîæ
                            </button>
                            <button id="result-mute-btn" class="result-btn secondary panic-btn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                    <line x1="23" y1="9" x2="17" y2="15"></line>
                                    <line x1="17" y1="9" x2="23" y2="15"></line>
                                </svg>
                                ÈùôÈü≥
                            </button>
                            <button id="play-again-btn" class="result-btn primary">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                                ÈáçÁé©
                            </button>
                            <button id="finish-game-btn" class="result-btn secondary">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="9 11 12 14 22 4"></polyline>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                                ÁªìÊùü
                            </button>
                        </div>
                    </div>
                    
                    <!-- ===== ‰∏ìÂÆ∂Ê®°ÂºèËßÜÂõæ (ÂÆåÂÖ®ÊõøÊç¢ÊôÆÈÄöËßÜÂõæ) ===== -->
                    <div id="expert-result-view" class="expert-view hidden">
                        <!-- È°∂ÈÉ®Ê†è -->
                        <div class="expert-header">
                            <div class="expert-title">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                                <span>‰∏ìÂÆ∂Ê®°Âºè</span>
                            </div>
                            <button id="exit-expert-btn" class="expert-exit-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                                ÈÄÄÂá∫‰∏ìÂÆ∂Ê®°Âºè
                            </button>
                        </div>
                        
                        <!-- ‰∏ªÂÜÖÂÆπÂå∫ - Â∑¶Âè≥ÂàÜÊ†è -->
                        <div class="expert-content">
                            <!-- Â∑¶‰æßÔºöË°å‰∏∫ÂàÜÊûê -->
                            <div class="expert-panel expert-left">
                                <h3 class="expert-panel-title">Ë°å‰∏∫Ê®°ÂºèÂàÜÊûê</h3>
                                
                                <!-- ÁÇπÂáªËΩ®Ëøπ -->
                                <div class="expert-section">
                                    <h4>ÁÇπÂáªËΩ®Ëøπ</h4>
                                    <div class="timeline-scatter" id="expert-timeline-scatter">
                                        <div class="scatter-row" data-lane="C"><span class="scatter-label">C</span><div class="scatter-track"></div></div>
                                        <div class="scatter-row" data-lane="D"><span class="scatter-label">D</span><div class="scatter-track"></div></div>
                                        <div class="scatter-row" data-lane="E"><span class="scatter-label">E</span><div class="scatter-track"></div></div>
                                        <div class="scatter-row" data-lane="G"><span class="scatter-label">G</span><div class="scatter-track"></div></div>
                                        <div class="scatter-row" data-lane="A"><span class="scatter-label">A</span><div class="scatter-track"></div></div>
                                    </div>
                                </div>
                                
                                <!-- Ê®°ÂºèËØÜÂà´ -->
                                <div class="expert-section">
                                    <h4>Ê®°ÂºèËØÜÂà´</h4>
                                    <div class="expert-pattern">
                                        <div class="pattern-type" id="expert-pattern-type">
                                            <span class="pattern-name">ÂàÜÊûê‰∏≠...</span>
                                        </div>
                                        <p class="pattern-desc" id="expert-pattern-desc">Á≠âÂæÖÊ∏∏ÊàèÊï∞ÊçÆ...</p>
                                        
                                        <div class="pattern-scores">
                                            <div class="score-item">
                                                <span class="score-label">
                                                    È°∫Â∫èÂûã
                                                    <span class="score-info" title="È°∫Â∫èÂëΩ‰∏≠Áéá>40% ‰∏î laneÂ§öÊ†∑ÊÄß‚â•4">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                                    </span>
                                                </span>
                                                <div class="score-bar-bg"><div class="score-bar-fill seq" id="expert-score-seq"></div></div>
                                                <span class="score-value" id="expert-score-seq-val">0%</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-label">
                                                    ÈáçÂ§çÂûã
                                                    <span class="score-info" title="‰∏ªÂØºlaneÂç†ÊØî>60%">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                                    </span>
                                                </span>
                                                <div class="score-bar-bg"><div class="score-bar-fill rep" id="expert-score-rep"></div></div>
                                                <span class="score-value" id="expert-score-rep-val">0%</span>
                                            </div>
                                            <div class="score-item">
                                                <span class="score-label">
                                                    Êé¢Á¥¢Âûã
                                                    <span class="score-info" title="laneÂ§öÊ†∑ÊÄß‚â•4 ‰∏î ‰∏ªÂØºlane‚â§60%">
                                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                                                    </span>
                                                </span>
                                                <div class="score-bar-bg"><div class="score-bar-fill exp" id="expert-score-exp"></div></div>
                                                <span class="score-value" id="expert-score-exp-val">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ê∏∏ÊàèÁªüËÆ° (‰∏ÄË°åÊòæÁ§∫) -->
                                <div class="expert-section expert-stats-inline">
                                    <h4>Ê∏∏ÊàèÁªüËÆ°</h4>
                                    <div class="stats-inline">
                                        <span>ÂáªÁ†¥ <strong id="expert-bubbles">0</strong> ‰∏™</span>
                                        <span class="stats-divider">|</span>
                                        <span>ÈÄüÂ∫¶ <strong id="expert-speed">0</strong>s/‰∏™</span>
                                        <span class="stats-divider">|</span>
                                        <span>ËøûÂáª <strong id="expert-combo">0</strong></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Âè≥‰æßÔºöÈü≥‰πêÂèÇÊï∞Ë∞ÉÊï¥ -->
                            <div class="expert-panel expert-right">
                                <h3 class="expert-panel-title">Èü≥‰πêÂèÇÊï∞Ë∞ÉÊï¥</h3>
                                
                                <!-- Ê®°ÂºèÂàáÊç¢ -->
                                <div class="param-mode-toggle">
                                    <button id="param-mode-test" class="mode-btn active">ÊµãËØïÊ®°Âºè</button>
                                    <button id="param-mode-converge" class="mode-btn">Êî∂ÊïõÊ®°Âºè</button>
                                </div>
                                
                                <div class="music-params-grid">
                                    <div class="param-item">
                                        <label>
                                            <span>ËäÇÂ•è (BPM) <span class="param-safe-range">ÂÆâÂÖ®: 60-80</span></span>
                                            <span id="tempo-warning" class="param-warning-badge hidden">‰∏çÂª∫ËÆÆÈÉ®ÁΩ≤</span>
                                        </label>
                                        <div class="param-control">
                                            <input type="range" id="report-param-tempo" min="40" max="120" value="72" class="safe-range-slider">
                                            <span id="report-param-tempo-value" class="param-value">72</span>
                                        </div>
                                    </div>
                                    
                                    <div class="param-item">
                                        <label>
                                            <span>Âä®ÊÄÅÂØπÊØîÂ∫¶ <span class="param-safe-range">ÂÆâÂÖ®: 0-20%</span></span>
                                            <span id="contrast-warning" class="param-warning-badge hidden">‰∏çÂª∫ËÆÆÈÉ®ÁΩ≤</span>
                                        </label>
                                        <div class="param-control">
                                            <input type="range" id="report-param-contrast" min="0" max="50" value="10" class="safe-range-slider">
                                            <span id="report-param-contrast-value" class="param-value">10%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="param-item">
                                        <label>
                                            <span>Èü≥Èáè <span class="param-safe-range">ÂÆâÂÖ®: 60-80%</span></span>
                                            <span id="volume-warning" class="param-warning-badge hidden">‰∏çÂª∫ËÆÆÈÉ®ÁΩ≤</span>
                                        </label>
                                        <div class="param-control">
                                            <input type="range" id="report-param-volume" min="0" max="100" value="70" class="safe-range-slider">
                                            <span id="report-param-volume-value" class="param-value">70%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="param-item">
                                        <label>
                                            <span>ÂíåÂ£∞ÁªÑÂêà <span class="param-safe-range">ÂÆâÂÖ®: I-V</span></span>
                                            <span id="harmony-warning" class="param-warning-badge hidden">‰∏çÂª∫ËÆÆÈÉ®ÁΩ≤</span>
                                        </label>
                                        <div class="harmony-options" id="harmony-options">
                                            <button class="harmony-btn safe active" data-value="I-V">I-V</button>
                                            <button class="harmony-btn unsafe" data-value="I-IV">I-IV</button>
                                            <button class="harmony-btn unsafe" data-value="I-vi">I-vi</button>
                                            <button class="harmony-btn unsafe" data-value="I-IV-V">I-IV-V</button>
                                            <button class="harmony-btn unsafe" data-value="I-vi-IV-V">I-vi-IV-V</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Êìç‰ΩúÊåâÈíÆ -->
                                <div class="param-actions">
                                    <button id="param-preview-btn" class="param-btn secondary">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                        È¢ÑËßà
                                    </button>
                                    <button id="param-stop-btn" class="param-btn secondary">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                                        ÊöÇÂÅú
                                    </button>
                                    <button id="param-reset-btn" class="param-btn secondary">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                                        ÈáçÁΩÆ
                                    </button>
                                </div>
                                
                                <!-- Êî∂ÊïõÊ®°ÂºèÊèê‰∫§Âå∫Âüü (‰∏ä‰∏ãÁïåÈÄâÊã©) -->
                                <div id="converge-submit-area" class="converge-submit-area hidden">
                                    <h4 class="converge-title">ËÆæÂÆöÂÆâÂÖ®Âå∫Èó¥</h4>
                                    <div class="converge-range-grid">
                                        <div class="converge-range-item">
                                            <label>BPM</label>
                                            <div class="range-inputs">
                                                <input type="number" id="converge-tempo-min" value="60" min="40" max="120" class="range-input">
                                                <span class="range-separator">~</span>
                                                <input type="number" id="converge-tempo-max" value="80" min="40" max="120" class="range-input">
                                            </div>
                                        </div>
                                        <div class="converge-range-item">
                                            <label>ÂØπÊØîÂ∫¶</label>
                                            <div class="range-inputs">
                                                <input type="number" id="converge-contrast-min" value="0" min="0" max="50" class="range-input">
                                                <span class="range-separator">~</span>
                                                <input type="number" id="converge-contrast-max" value="20" min="0" max="50" class="range-input">
                                                <span class="range-unit">%</span>
                                            </div>
                                        </div>
                                        <div class="converge-range-item">
                                            <label>Èü≥Èáè</label>
                                            <div class="range-inputs">
                                                <input type="number" id="converge-volume-min" value="60" min="0" max="100" class="range-input">
                                                <span class="range-separator">~</span>
                                                <input type="number" id="converge-volume-max" value="80" min="0" max="100" class="range-input">
                                                <span class="range-unit">%</span>
                                            </div>
                                        </div>
                                        <div class="converge-range-item">
                                            <label>ÂíåÂ£∞</label>
                                            <div class="converge-harmony-btns" id="converge-harmony-btns">
                                                <button class="converge-harmony-btn selected" data-value="I-V">I-V</button>
                                                <button class="converge-harmony-btn" data-value="I-IV">I-IV</button>
                                                <button class="converge-harmony-btn" data-value="I-vi">I-vi</button>
                                                <button class="converge-harmony-btn" data-value="I-IV-V">I-IV-V</button>
                                                <button class="converge-harmony-btn" data-value="I-vi-IV-V">I-vi-IV-V</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="converge-actions">
                                        <button id="param-submit-btn" class="param-btn primary">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline></svg>
                                            ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                                        </button>
                                        <p class="submit-note">Êï∞ÊçÆÂ∫ìËøûÊé•Â∞öÊú™ÈÖçÁΩÆ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Âè≥‰æßÂÆûÊó∂ÁõëÊéßÈù¢Êùø -->
        <div id="game-sidebar" class="game-sidebar">
            <div class="sidebar-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>
                <span class="sidebar-title">ÂÆûÊó∂ÁõëÊéß</span>
                <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" title="Â±ïÂºÄ/Êî∂Ëµ∑">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
            </div>
            
            <div class="sidebar-content">
                <!-- ÂÆûÊó∂Êï∞ÊçÆ -->
                <div class="sidebar-section">
                    <h4 class="section-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        ÂÆûÊó∂Êï∞ÊçÆ
                    </h4>
                    <div class="debug-mini-stats">
                        <div class="mini-stat">
                            <span class="mini-label">ÁÇπÂáªÊï∞</span>
                            <span id="rt-clicks" class="mini-value">0</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-label">‰∏ªÂØºLane</span>
                            <span id="rt-dominant" class="mini-value">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Lane ÂàÜÂ∏É -->
                <div class="sidebar-section">
                    <h4 class="section-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                        Lane ÂàÜÂ∏É
                    </h4>
                    <div id="rt-lane-bars" class="rt-lane-bars">
                        <div class="lane-bar" data-lane="1" style="--lane-color: #F87171;"><span>C</span></div>
                        <div class="lane-bar" data-lane="2" style="--lane-color: #FB923C;"><span>D</span></div>
                        <div class="lane-bar" data-lane="3" style="--lane-color: #FBBF24;"><span>E</span></div>
                        <div class="lane-bar" data-lane="4" style="--lane-color: #60A5FA;"><span>G</span></div>
                        <div class="lane-bar" data-lane="5" style="--lane-color: #A78BFA;"><span>A</span></div>
                    </div>
                </div>
                
                <!-- Ê®°ÂºèÈ¢ÑÊµã -->
                <div class="sidebar-section">
                    <h4 class="section-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        Ê®°ÂºèÈ¢ÑÊµã
                        <span class="info-icon" data-tooltip="üéπ È°∫Â∫èÂûã: È°∫Â∫èÂëΩ‰∏≠Áéá>40% ‰∏î lane‚â•4&#10;üîÅ ÈáçÂ§çÂûã: ‰∏ªÂØºlaneÂç†ÊØî>60%&#10;üåà Êé¢Á¥¢Âûã: lane‚â•4 ‰∏î ‰∏ªÂØº‚â§60%">‚ìò</span>
                    </h4>
                    <div id="rt-pattern" class="rt-pattern">
                        <span class="pattern-label">Á≠âÂæÖÊõ¥Â§öÊï∞ÊçÆ...</span>
                    </div>
                </div>
                
                <!-- ÊúÄËøëÁÇπÂáª -->
                <div class="sidebar-section">
                    <h4 class="section-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                        ÊúÄËøëÁÇπÂáª
                    </h4>
                    <div id="rt-recent-clicks" class="rt-recent-clicks">
                        <span class="no-data">ÊöÇÊó†</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <div class="game-footer">
            <div class="instructions">
                <p style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="6"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                    </svg>
                    ÁßªÂä®ÂÖâÊ†áÊà≥Ê≥°Ê≥°
                </p>
                <div class="status-display" style="display: flex; gap: 20px; justify-content: center; margin: 10px 0;">
                    <div class="status-item">
                        <span>ËæìÂÖ•ÊñπÂºè: </span>
                        <span id="input-mode-footer" style="font-weight: 600; color: var(--accent-primary);">Èº†Ê†á</span>
                    </div>
                    <div class="status-item">
                        <span>Ê≥°Ê≥°Êï∞: </span>
                        <span id="bubble-count-footer" style="font-weight: 600; color: var(--accent-success);">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Settings Modal -->
    <div id="session-settings-modal" class="settings-modal hidden">
        <div class="settings-panel">
            <div class="settings-header">
                <h2>Ê∏∏ÊàèËÆæÁΩÆ</h2>
                <p class="settings-subtitle">Ë∞ÉÊï¥ÊÑüÂÆò‰ΩìÈ™åÔºåËÆ©Ê∏∏ÊàèÊõ¥ÈÄÇÂêà‰Ω†</p>
            </div>
            
            <div class="settings-scroll-area">
                <div class="settings-grid-new">
                    <!-- Èü≥ÈáèÂ§ßÂ∞è -->
                    <div class="settings-field-new">
                        <label class="settings-label-with-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                            <span>Èü≥Èáè</span>
                        </label>
                        <div class="segmented-control" data-field="session-volume">
                            <button type="button" class="segment" data-value="low" title="ÊüîÂíå">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                                <span>ÊüîÂíå</span>
                            </button>
                            <button type="button" class="segment active" data-value="medium" title="Ê†áÂáÜ">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                <span>Ê†áÂáÜ</span>
                            </button>
                            <button type="button" class="segment" data-value="high" title="Âìç‰∫Æ">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                <span>Âìç‰∫Æ</span>
                            </button>
                        </div>
                        <input type="hidden" id="session-volume" value="medium">
                    </div>

                    <!-- ‰πêÂô®Èü≥Ëâ≤ -->
                    <div class="settings-field-new">
                        <label class="settings-label-with-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                            <span>Èü≥Ëâ≤</span>
                        </label>
                        <div class="segmented-control" data-field="session-timbre">
                            <button type="button" class="segment active" data-value="soft" title="ÊüîÂíåÈí¢Áê¥">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                                <span>ÊüîÂíå</span>
                            </button>
                            <button type="button" class="segment" data-value="bright" title="Êòé‰∫ÆÂ∞èÊèêÁê¥">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                <span>Êòé‰∫Æ</span>
                            </button>
                        </div>
                        <input type="hidden" id="session-timbre" value="soft">
                    </div>

                    <!-- Â£∞Èü≥Âª∂Ëøü -->
                    <div class="settings-field-new">
                        <label class="settings-label-with-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            <span>Âª∂Ëøü</span>
                        </label>
                        <div class="segmented-control" data-field="session-latency">
                            <button type="button" class="segment active" data-value="0" title="Âç≥Êó∂">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                <span>Âç≥Êó∂</span>
                            </button>
                            <button type="button" class="segment" data-value="500" title="Á®çÊÖ¢">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                <span>Á®çÊÖ¢</span>
                            </button>
                        </div>
                        <input type="hidden" id="session-latency" value="0">
                    </div>

                    <!-- ÁÇπÂáªÂèçÈ¶à -->
                    <div class="settings-field-new">
                        <label class="settings-label-with-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span>ÂèçÈ¶àÈü≥Êïà</span>
                        </label>
                        <div class="segmented-control" data-field="session-immediate">
                            <button type="button" class="segment active" data-value="full" title="ÂºÄÂêØ">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                <span>ÂºÄÂêØ</span>
                            </button>
                            <button type="button" class="segment" data-value="off" title="ÂÖ≥Èó≠">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
                                <span>ÂÖ≥Èó≠</span>
                            </button>
                        </div>
                        <input type="hidden" id="session-immediate" value="full">
                    </div>
                </div>
            </div>

            <!-- ÈöêËóèÁöÑÈªòËÆ§ÂÄºÂ≠óÊÆµ -->
            <input type="hidden" id="session-density" value="normal">
            <input type="hidden" id="session-reward" value="on">

            <div class="settings-actions">
                <button id="session-reset-btn" class="result-btn secondary small">ÊÅ¢Â§çÈªòËÆ§</button>
                <button id="session-start-btn" class="result-btn primary small">ÂºÄÂßãÊ∏∏Êàè</button>
                <button id="session-close-btn" class="result-btn secondary small">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script src="js/i18n.js"></script>
    <script src="js/audio-notes.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/note-log.js"></script>
    <script src="js/advanced-music-generator.js"></script>
    <script src="js/autism-friendly-features.js"></script>
    
    <!-- Expert Audit Mode Scripts -->
    <script src="js/safety-envelope.js"></script>
    <script src="js/session-logger.js"></script>
    <script src="js/expert-drawer.js"></script>
    <script src="js/audit-dashboard.js"></script>
    <script src="js/sidebar-controller.js"></script>

    <script src="js/game-result-manager.js"></script>
    <script src="js/music-param-controller.js"></script>
    <script src="js/game-integration.js"></script>
    <script src="js/debug-collision.js"></script>

    <script src="js/bubble-manager.js"></script>
    <script src="js/collision-detector.js"></script>
    <script src="js/game-engine.js"></script>

  
    <!-- TFJS & MagentaÔºàÂú®‰ªìÂ∫ìÊ†πÁöÑ vendor ‰∏ãÔºâ -->
    <script src="../../vendor/tf/tf.min.js"></script>
    <script src="../../vendor/magenta/music.js"></script>

    <!-- ÂÖ•Âè£‰øùÊåÅ module -->
    <script type="module" src="./js/main.js"></script>
</body>
</html>
