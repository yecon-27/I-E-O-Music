<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Popping Game</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
      .lane-labels {
        position: absolute;
        left: 0;
        bottom: 8px;
        width: 100%;
        pointer-events: none;
        z-index: 5;
      }
      .lane-labels .lane-label {
        position: absolute;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        color: #ffffff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      }
      .click-trail {
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        pointer-events: none;
        font-size: 12px;
        font-weight: 700;
        background: rgba(0,0,0,0.12);
        border-radius: 14px;
        z-index: 6;
      }
      .click-trail .trail-dot {
        min-width: 18px;
        min-height: 18px;
        padding: 2px 6px;
        border-radius: 10px;
        color: #fff;
        text-align: center;
        line-height: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.25);
      }
      .click-trail .trail-title {
        color: #fff;
        opacity: 0.8;
      }
      .game-main { position: relative; }
    </style>
</head>
<body>


    <div class="game-container">
        <div class="game-header">
            <div class="score-display">
                <span class="score-label">Score:</span>
                <span id="score-value">0</span>
            </div>
                <div class="controls">
                    <!-- 自闭症友好控制面板 -->
                    <div class="autism-controls">
                        <button id="sensory-panel-toggle" class="control-btn">🎛️ 感官设置</button>
                    <div id="sensory-panel" class="sensory-panel hidden">
                        <div class="sensory-control">
                            <label>🔊 音效音量:</label>
                            <input type="range" id="sound-volume" min="0" max="100" value="70">
                            <span id="sound-volume-value">70%</span>
                        </div>

                        <div class="sensory-control">
                            <label>🎨 色彩模式:</label>
                            <select id="color-mode">
                                <option value="normal">标准</option>
                                <option value="high-contrast">高对比度</option>
                                <option value="soft">柔和</option>
                            </select>
                        </div>
                        <div class="sensory-control">
                            <label>🔄 规律模式:</label>
                            <input type="checkbox" id="predictable-mode">
                            <span>泡泡按固定位置出现</span>
                        </div>
                    </div>
                </div>
                
                    <button id="pause-btn" class="control-btn">⏸️ 暂停</button>
                    <button id="session-settings-btn" class="control-btn">⚙️ 参数</button>
                    <button id="panic-mute-btn" class="control-btn panic-btn">🔇 停止/静音</button>
                    
                    <div class="speed-controls">
                        <button id="slow-btn" class="speed-btn">🐌 慢速</button>
                        <button id="normal-btn" class="speed-btn active">🚶 正常</button>
                        <button id="fast-btn" class="speed-btn">🏃 快速</button>
                    </div>
                
                <!-- 进度指示器 -->
                <div class="progress-indicator">
                    <div class="time-remaining">
                        <span>⏱️ 剩余: </span>
                        <span id="countdown-display">60s</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                </div>
                
                <div id="session-preset" class="session-preset">Preset: medium / normal / soft</div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="game-main">
                <canvas id="game-canvas" width="1024" height="768"></canvas>
                <div id="click-trail" class="click-trail"></div>
                <div id="lane-labels" class="lane-labels"></div>
                <div id="encouragement-message" class="encouragement-message"></div>
                <div id="pause-overlay" class="pause-overlay hidden">
                    <h2>游戏已暂停</h2>
                    <p>点击继续按钮恢复游戏</p>
                </div>
                
                <!-- 游戏结果窗口 -->
                <div id="game-result-overlay" class="game-result-overlay hidden">
                    <div class="result-content">
                        <h2>🎉 游戏结束！</h2>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-icon">🎯</span>
                                <span class="stat-label">成功击破</span>
                                <span id="result-bubbles" class="stat-value">0</span>
                                <span class="stat-unit">个泡泡</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">⚡</span>
                                <span class="stat-label">平均速度</span>
                                <span id="result-speed" class="stat-value">0</span>
                                <span class="stat-unit">秒/个</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">🏆</span>
                                <span class="stat-label">最高连击</span>
                                <span id="result-combo" class="stat-value">0</span>
                                <span class="stat-unit">连续</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">🤚</span>
                                <span class="stat-label">手部偏好</span>
                                <span id="result-hand-preference" class="stat-value">平衡</span>
                                <span class="stat-unit">使用</span>
                            </div>
                        </div>
                        <div class="result-message">
                            <p id="result-encouragement">太棒了！你的表现很出色！</p>
                        </div>
                        <div id="debug-panel" class="debug-panel">
                            <div class="debug-header">
                                <h3>Post-Session Review</h3>
                                <div class="debug-header-actions">
                                    <button id="debug-help-toggle" class="result-btn secondary small">How to read</button>
                                    <button id="open-reward-controls-btn" class="result-btn secondary small">Open Reward Controls</button>
                                </div>
                            </div>
                            <div id="debug-help" class="debug-help hidden">
                                <strong>How to read this panel</strong>
                                <ol>
                                    <li>Q1：判定结果 + 安全状态</li>
                                    <li>Q2：证据可视化 + Top-3 规则</li>
                                    <li>Q3：反事实解释 + 审计</li>
                                </ol>
                            </div>
                            <div class="debug-section">
                                <h4 class="debug-section-title">Q1：系统判定了什么？是否安全？</h4>
                                <div class="debug-overview">
                                    <div class="overview-item">
                                        <span class="overview-label">判定结果（主/次）</span>
                                        <span id="debug-summary-decision" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">置信度</span>
                                        <span id="debug-summary-confidence" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">安全状态</span>
                                        <span id="debug-summary-safety" class="overview-value">-</span>
                                    </div>
                                    <div class="overview-item">
                                        <span class="overview-label">Reward 概览</span>
                                        <span id="debug-summary-reward" class="overview-value">-</span>
                                    </div>
                                </div>
                                <div id="debug-summary-reason" class="debug-reason">-</div>
                                <div class="debug-grid">
                                    <div class="debug-block">
                                        <h4>生成结构摘要</h4>
                                        <ul id="debug-structure-list" class="debug-list"></ul>
                                    </div>
                                </div>
                            </div>

                            <div class="debug-section">
                                <h4 class="debug-section-title">Q2：为什么这么判？证据长什么样？</h4>
                                <div class="debug-grid">
                                    <div class="debug-block debug-block-wide">
                                        <h4>点击轨迹与 Lane 分布</h4>
                                        <canvas id="debug-timeline" class="debug-timeline" width="640" height="90"></canvas>
                                        <div id="debug-lane-bars" class="debug-lane-bars"></div>
                                    </div>
                                    <div class="debug-block">
                                        <h4>检测到的 Pattern（数字证据）</h4>
                                        <ul id="debug-what-list" class="debug-list"></ul>
                                    </div>
                                    <div class="debug-block">
                                        <h4>Top-3 规则证据</h4>
                                        <ul id="debug-why-list" class="debug-list"></ul>
                                        <details class="debug-details">
                                            <summary>查看更多规则</summary>
                                            <ul id="debug-why-details-list" class="debug-list"></ul>
                                        </details>
                                    </div>
                                    <div class="debug-block">
                                        <h4>三类证据得分（用于决策）</h4>
                                        <ul id="debug-signal-list" class="debug-list"></ul>
                                        <div class="debug-note">最终标签=得分最高者；差距越大→置信度越高。</div>
                                    </div>
                                </div>
                            </div>

                            <div class="debug-section">
                                <h4 class="debug-section-title">Q3：如果专家不同意，怎么调？</h4>
                                <div class="debug-grid">
                                    <div class="debug-block">
                                        <h4>What would change the decision?</h4>
                                        <ul id="debug-counterfactual-list" class="debug-list"></ul>
                                    </div>
                                    <div class="debug-block">
                                        <h4>约束审计（Audit）</h4>
                                        <ul id="debug-constraint-list" class="debug-list"></ul>
                                        <div class="debug-note">Safety by design: reward 生成器=约束集合，而不是事后过滤。</div>
                                    </div>
                                    <div class="debug-block">
                                        <h4>本轮配置 / 变更记录</h4>
                                        <ul id="debug-config-list" class="debug-list"></ul>
                                        <div class="debug-note">展示与保守默认值的差异，便于审计与复现。</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button id="play-music-btn" class="result-btn music">🎵 享受你创作的音乐</button>
                            <button id="result-mute-btn" class="result-btn secondary panic-btn">🔇 停止/静音</button>
                            <button id="play-again-btn" class="result-btn primary">🎮 再玩一轮</button>
                            <button id="finish-game-btn" class="result-btn secondary">✨ 结束游戏</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="game-footer">
            <div class="instructions">
                <p>🎯 移动光标戳泡泡！</p>
                <div class="status-display" style="display: flex; gap: 20px; justify-content: center; margin: 10px 0;">
                    <div class="status-item">
                        <span>输入方式: </span>
                        <span id="input-mode" style="font-weight: bold; color: #2196F3;">鼠标</span>
                    </div>
                    <div class="status-item">
                        <span>泡泡数: </span>
                        <span id="bubble-count" style="font-weight: bold; color: #4CAF50;">0</span>
                    </div>
                </div>
                <div id="debug-info" class="debug-info" style="font-size: 0.9rem; color: #6C757D; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Session Settings Modal -->
    <div id="session-settings-modal" class="settings-modal hidden">
        <div class="settings-panel">
            <h2>Session Settings</h2>
            <p class="settings-subtitle">当前设置会用于本轮 / 下一轮</p>
            <div class="settings-mode">
                <div class="settings-mode-toggle" role="group" aria-label="Session mode">
                    <button type="button" id="session-mode-safe" class="mode-btn active">默认/安全</button>
                    <button type="button" id="session-mode-expert" class="mode-btn">专家/调参</button>
                </div>
                <div id="session-mode-note" class="settings-mode-note">默认/安全模式：使用保守默认值（只读）。</div>
            </div>
            <div class="settings-disclaimer">
                保守默认值 + 可调包络（用于专家校准，不是临床验证阈值）。
            </div>
            <div class="settings-grid">
                <div class="settings-field">
                    <label for="session-volume">音量</label>
                    <select id="session-volume">
                        <option value="low">low</option>
                        <option value="medium" selected>medium</option>
                        <option value="high">high</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: medium | 可调: low/medium/high | 风险: 过高可能刺激</span>
                        <button class="settings-reset" type="button" data-reset-field="volumeLevel">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field">
                    <label for="session-density">节奏密度</label>
                    <select id="session-density">
                        <option value="sparse">sparse</option>
                        <option value="normal" selected>normal</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: normal | 可调: sparse/normal | 风险: 过密增加负荷</span>
                        <button class="settings-reset" type="button" data-reset-field="rhythmDensity">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field">
                    <label for="session-timbre">音色</label>
                    <select id="session-timbre">
                        <option value="soft" selected>soft</option>
                        <option value="bright">bright</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: soft | 可调: soft/bright | 风险: bright 更刺激</span>
                        <button class="settings-reset" type="button" data-reset-field="timbre">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field">
                    <label for="session-latency">反馈延迟</label>
                    <select id="session-latency">
                        <option value="0" selected>Immediate</option>
                        <option value="500">0.5s Delay</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: Immediate | 可调: 0/0.5s | 风险: 延迟影响因果感</span>
                        <button class="settings-reset" type="button" data-reset-field="feedbackLatencyMs">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field">
                    <label for="session-immediate">即时音模式</label>
                    <select id="session-immediate">
                        <option value="full" selected>Full</option>
                        <option value="visual">Visual-only</option>
                        <option value="off">Off</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: Full | 可调: full/visual/off | 风险: 反馈过强</span>
                        <button class="settings-reset" type="button" data-reset-field="immediateToneMode">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field">
                    <label for="session-reward">Reward 音乐</label>
                    <select id="session-reward">
                        <option value="on" selected>On</option>
                        <option value="off">Off</option>
                    </select>
                    <div class="settings-field-meta">
                        <span>默认: On | 可调: On/Off | 风险: Off 仅保留即时反馈</span>
                        <button class="settings-reset" type="button" data-reset-field="rewardEnabled">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field full">
                    <label for="session-bpm">Reward BPM</label>
                    <div class="settings-slider">
                        <input type="range" id="session-bpm" min="65" max="75" step="1" value="72">
                        <span id="session-bpm-value" class="settings-slider-value">72 BPM</span>
                    </div>
                    <div class="settings-field-meta">
                        <span>默认: 72 | 可调: 65–75 | 风险: 过快难预测</span>
                        <button class="settings-reset" type="button" data-reset-field="rewardBpm">恢复默认</button>
                    </div>
                </div>
                <div class="settings-field full">
                    <label for="session-duration">Reward 时长</label>
                    <div class="settings-slider">
                        <input type="range" id="session-duration" min="10" max="20" step="1" value="20">
                        <span id="session-duration-value" class="settings-slider-value">20s</span>
                    </div>
                    <div class="settings-field-meta">
                        <span>默认: 20s | 可调: 10–20s | 风险: 过长可能过载</span>
                        <button class="settings-reset" type="button" data-reset-field="rewardDurationSec">恢复默认</button>
                    </div>
                </div>
            </div>
            <div class="settings-actions">
                <button id="session-reset-btn" class="result-btn secondary">恢复默认</button>
                <button id="session-start-btn" class="result-btn primary">开始本轮</button>
                <button id="session-close-btn" class="result-btn secondary">关闭</button>
            </div>
        </div>
    </div>

    <script src="js/audio-notes.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/note-log.js"></script>
    <script src="js/advanced-music-generator.js"></script>
    <script src="js/autism-friendly-features.js"></script>
    <script src="js/game-result-manager.js"></script>
    <script src="js/game-integration.js"></script>
    <script src="js/debug-collision.js"></script>

    <script src="js/bubble-manager.js"></script>
    <script src="js/collision-detector.js"></script>
    <script src="js/game-engine.js"></script>

  
    <!-- TFJS & Magenta（在仓库根的 vendor 下） -->
    <script src="../../vendor/tf/tf.min.js"></script>
    <script src="../../vendor/magenta/music.js"></script>

    <!-- 入口保持 module -->
    <script type="module" src="./js/main.js"></script>
</body>
</html>
