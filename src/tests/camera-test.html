<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘„åƒå¤´æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ æ‘„åƒå¤´æµ‹è¯•å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©è¯Šæ–­æ‘„åƒå¤´è®¿é—®é—®é¢˜</p>
        
        <div id="status" class="status info">
            ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"æŒ‰é’®å¼€å§‹æµ‹è¯•
        </div>
        
        <div>
            <button id="startBtn" onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
            <button id="stopBtn" onclick="stopCamera()" disabled>åœæ­¢æ‘„åƒå¤´</button>
            <button id="checkBtn" onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
        </div>
        
        <video id="video" autoplay muted playsinline style="display: none;"></video>
        
        <div id="debug" class="debug" style="display: none;"></div>
        
        <div style="margin-top: 20px;">
            <h3>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š</h3>
            <ul>
                <li><strong>æƒé™è¢«æ‹’ç»ï¼š</strong> ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„æ‘„åƒå¤´å›¾æ ‡ï¼Œå…è®¸è®¿é—®</li>
                <li><strong>HTTPSè¦æ±‚ï¼š</strong> å°è¯•ä½¿ç”¨ <code>https://localhost:8443</code> è®¿é—®</li>
                <li><strong>æµè§ˆå™¨å…¼å®¹æ€§ï¼š</strong> å»ºè®®ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeæœ€æ–°ç‰ˆæœ¬</li>
                <li><strong>æ‘„åƒå¤´è¢«å ç”¨ï¼š</strong> å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨ç¨‹åº</li>
            </ul>
        </div>
    </div>

    <script>
        let stream = null;
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            logDebug(`[${type.toUpperCase()}] ${message}`);
        }

        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent += `[${timestamp}] ${message}\n`;
            debug.style.display = 'block';
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }

        async function checkPermissions() {
            try {
                logDebug('æ£€æŸ¥æ‘„åƒå¤´æƒé™...');
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    updateStatus('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®', 'error');
                    return;
                }

                // æ£€æŸ¥æƒé™çŠ¶æ€
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({ name: 'camera' });
                    logDebug(`æ‘„åƒå¤´æƒé™çŠ¶æ€: ${permission.state}`);
                    
                    switch (permission.state) {
                        case 'granted':
                            updateStatus('æ‘„åƒå¤´æƒé™å·²æˆäºˆ', 'success');
                            break;
                        case 'denied':
                            updateStatus('æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®', 'error');
                            break;
                        case 'prompt':
                            updateStatus('éœ€è¦è¯·æ±‚æ‘„åƒå¤´æƒé™', 'info');
                            break;
                    }
                } else {
                    logDebug('æµè§ˆå™¨ä¸æ”¯æŒæƒé™æŸ¥è¯¢API');
                }

                // æ£€æŸ¥å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');
                logDebug(`å‘ç° ${cameras.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡`);
                
                cameras.forEach((camera, index) => {
                    logDebug(`æ‘„åƒå¤´ ${index + 1}: ${camera.label || 'æœªçŸ¥è®¾å¤‡'}`);
                });

                if (cameras.length === 0) {
                    updateStatus('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡', 'error');
                } else {
                    updateStatus(`æ£€æµ‹åˆ° ${cameras.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡`, 'success');
                }

            } catch (error) {
                logDebug(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`);
                updateStatus(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function startCamera() {
            try {
                updateStatus('æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...', 'info');
                startBtn.disabled = true;

                // è¯·æ±‚æ‘„åƒå¤´è®¿é—®
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };

                logDebug('è¯·æ±‚æ‘„åƒå¤´è®¿é—®...');
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // è®¾ç½®è§†é¢‘æµ
                video.srcObject = stream;
                video.style.display = 'block';
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });

                updateStatus('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼', 'success');
                startBtn.disabled = false;
                stopBtn.disabled = false;

                // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                logDebug(`è§†é¢‘åˆ†è¾¨ç‡: ${settings.width}x${settings.height}`);
                logDebug(`è®¾å¤‡æ ‡ç­¾: ${track.label}`);

            } catch (error) {
                logDebug(`æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.name} - ${error.message}`);
                
                let errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ';
                switch (error.name) {
                    case 'NotAllowedError':
                        errorMessage += 'æƒé™è¢«æ‹’ç»ï¼Œè¯·å…è®¸æ‘„åƒå¤´è®¿é—®';
                        break;
                    case 'NotFoundError':
                        errorMessage += 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                        break;
                    case 'NotReadableError':
                        errorMessage += 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨';
                        break;
                    case 'OverconstrainedError':
                        errorMessage += 'æ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„é…ç½®';
                        break;
                    case 'SecurityError':
                        errorMessage += 'å®‰å…¨é™åˆ¶ï¼Œè¯·ä½¿ç”¨HTTPSè®¿é—®';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                updateStatus(errorMessage, 'error');
                startBtn.disabled = false;
            }
        }

        function stopCamera() {
            if (stream) {
                logDebug('åœæ­¢æ‘„åƒå¤´...');
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                video.style.display = 'none';
                updateStatus('æ‘„åƒå¤´å·²åœæ­¢', 'info');
                stopBtn.disabled = true;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æƒé™
        window.addEventListener('load', () => {
            logDebug('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ...');
            checkPermissions();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>